name: Send Lichess Messages from list.txt

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # â° runs every hour at minute 0

jobs:
  send_messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      # ğŸ•’ Time check â€” cancel if before 31 Oct 2025 18:30 IST
      - name: Check time (cancel if before 31 Oct 2025 18:30 IST)
        id: timecheck
        run: |
          export TZ='Asia/Kolkata'
          current_ist_epoch=$(date '+%s')
          target_ist_epoch=$(date -d "2025-10-31 20:45:00" '+%s')
          echo "ğŸ¯ Target IST : 2025-10-31 20:45:00 IST"
          echo "â³ Not yet 31 Oct 2025 20:45 IST â€” about ${hrs}h ${mins}m left. Cancelling workflow."
 

          if [ "$current_ist_epoch" -lt "$target_ist_epoch" ]; then
            remaining=$((target_ist_epoch - current_ist_epoch))
            hrs=$((remaining / 3600))
            mins=$(((remaining % 3600) / 60))
            echo "â³ Not yet 31 Oct 2025 18:30 IST â€” about ${hrs}h ${mins}m left. Cancelling workflow."
            exit 78
          else
            echo "âœ… Target time reached, continuing..."
          fi

      # ğŸ“¤ Send messages
      - name: Send messages from list.txt
        env:
          LICHESS_KEY: ${{ secrets.LICHESS_KEY }}
        run:  python -u send_team_msg.py
          
      # ğŸ§¹ Delete msg.txt and list.txt from repo permanently
      - name: Delete msg.txt and list.txt from repo
        if: success()
        run: |
          echo "ğŸ§¹ Deleting msg.txt and list.txt from repo..."
          rm -f msg.txt
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add -u
          git commit -m "ğŸ§¹ Auto-delete msg.txt and list.txt after sending messages" || echo "No changes to commit"
          git push
          echo "âœ… Files deleted and pushed successfully."
